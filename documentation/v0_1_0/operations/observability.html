<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Observability</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">
    
  
  
  <!-- ** Plugins Needed for the Project ** -->
  
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css">
  

  <link href="/assets/scss/syntax_monokai.css" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link href="/assets/scss/style.css" rel="stylesheet">

  <!--Favicon-->
  <link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/assets/images/flotta-logo-stacked.ico " type="image/x-icon">

  <!-- google analytics -->
  

</head>


<body>

  <header class="navigation fixed-top nav-bg">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand font-tertiary h3" href="/">
      
        <img src="/assets/images/flotta-logo.png" alt="Project Flotta" style="height: 60px;">
        
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
      aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navigation">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home</a>
        </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/blog.html">Blog</a>
          </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/documentation/v0_1_0/intro/overview.html">Documentation</a>
          </li>
        
      </ul>
    </div>
  </nav>
</header>


  <section class="section skip_top">
  <div class="container">
    <div class="row">
      <div class="col-lg-4">
        
        
        <ul class="list-group list-group-collapse border-0">
          
            <li class="list-group-item border-0">
              <h5>
                
                  Intro
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/overview.html">What is flotta</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/usecases.html">Use cases</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/vs.html">Flotta vs others</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/concepts.html">Concepts</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  Getting started
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/minikube.html">Minikube</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/kind.html">Kind</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/ocp.html">OCP</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/running_workloads.html">Running workloads</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  Operations
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/requirements.html">System Requirements</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/deployment_options.html">Deployment options</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/configuration.html">Configuration</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/observability.html">Observability</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/data_upload.html">Data upload</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/troubleshooting.html">Troubleshooting</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/api.html">API reference</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/crd.html">CRD reference</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  For developers
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/installation.html">Manual installation & tips</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/guide.html">Development Guide</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/profiling.html">Profiling</a> </li>
                  
                </ul>
              
            </li>
          
        </ul>
        <p>Documentation for version: <b>v0.1.0</b></p>
        <b>Other versions</b>
        <ul class="list-group list-group-collapse border-0">
        
          
          
            <li class="list-group-item border-0">

              
              <a href="/documentation/latest/intro/overview.html"> latest</a>
            </li>
        
          
          
            <li class="list-group-item border-0">

              
              <a href="/documentation/v0_1_0/intro/overview.html"> v0.1.0</a>
            </li>
        
        </ul>
      </div>

      <div class="col-lg-8">
        <div class="documentation content">
          
            <!-- Some cases we don't want to show the title -->
            <h1 class="font-tertiary mb-5">Observability</h1>
          
          

          <h1 id="device-metrics">Device metrics</h1>

<p>Edge devices can collect metrics from all deployed workloads and the system of
the device itself. The collected metrics are sent to a <code class="language-plaintext highlighter-rouge">metrics receiver</code>. This
document describes how that functionality can be configured.</p>

<h2 id="system-metrics">System metrics</h2>

<h3 id="collection-frequency">Collection frequency</h3>

<p>System metrics collection is enabled by default and the Flotta agent will start
gathering them when the device is started - with default intervals of <strong>60</strong>
seconds. Said interval can be customized by setting desired frequency (in
seconds) in an <code class="language-plaintext highlighter-rouge">EdgeDevice</code> CR.</p>

<p>For instance, following spec snippet would instruct the device worker to collect
system metrics every 5 minutes.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
  <span class="na">metrics</span><span class="pi">:</span>
    <span class="na">system</span><span class="pi">:</span>
      <span class="na">interval</span><span class="pi">:</span> <span class="m">300</span>
</code></pre></div></div>

<h3 id="allow-lists">Allow-lists</h3>

<p>By default, the device worker would collect only pre-defined, narrow list of
system metrics; user can modify the set of collected metrics using <em>system
metrics allow-list</em>.</p>

<p>Allow-list configuration comprises two elements:</p>
<ul>
  <li><code class="language-plaintext highlighter-rouge">ConfigMap</code> containing a list of metrics to be collected (exclusively)</li>
  <li>Reference to the above <code class="language-plaintext highlighter-rouge">ConfigMap</code> in the <code class="language-plaintext highlighter-rouge">EdgeDevice</code> system metrics configuration</li>
</ul>

<p>Sample allow-list <code class="language-plaintext highlighter-rouge">ConfigMap</code> (mind <code class="language-plaintext highlighter-rouge">metrics_list.yaml</code> key):</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">ConfigMap</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">system-allow-list</span>
  <span class="na">namespace</span><span class="pi">:</span> <span class="s">devices</span>
<span class="na">data</span><span class="pi">:</span>
  <span class="na">metrics_list.yaml</span><span class="pi">:</span> <span class="pi">|</span>
    <span class="s">names:</span>
      <span class="s">- node_disk_io_now</span>
      <span class="s">- node_memory_Mapped_bytes</span>
      <span class="s">- node_network_speed_bytes</span>
</code></pre></div></div>

<p>Reference to the above <code class="language-plaintext highlighter-rouge">ConfigMap</code> in an <code class="language-plaintext highlighter-rouge">EdgeDevice</code> spec:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
  <span class="na">metrics</span><span class="pi">:</span>
    <span class="na">system</span><span class="pi">:</span>
      <span class="na">allowList</span><span class="pi">:</span> 
          <span class="na">name</span><span class="pi">:</span> <span class="s">system-allow-list</span>
</code></pre></div></div>
<h2 id="metrics-receiver">Metrics receiver</h2>

<h3 id="overview">Overview</h3>

<p>The devices can be configured to write the metrics to a remote server. The
client in the device uses <a href="https://docs.google.com/document/d/1LPhVRSFkGNSuU1fBd81ulhsCPR4hkSZyyBj1SZ8fWOM/edit#heading=h.p12mxouu8g0h">Prometheus Remote Write
API</a>
(see also <a href="https://prometheus.io/docs/operating/integrations/">Prometheus
Integrations</a>). The device
writes metrics until it reaches the end of the TSDB contents. It then waits 5
minutes for more metrics to be collected.</p>

<h3 id="configuration">Configuration</h3>

<p>The feature is disabled by default. It is configured via
EdgeDevice/EdgeDeviceSet CRs. Example with inline documentation and defaults:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">spec</span><span class="pi">:</span>
    <span class="na">metrics</span><span class="pi">:</span>
      <span class="na">receiverConfiguration</span><span class="pi">:</span>
        <span class="na">caSecretName</span><span class="pi">:</span> <span class="s">receiver-tls</span> <span class="c1"># secret containing CA cert. Secret key is 'ca.crt'. Optional</span>
        <span class="na">requestNumSamples</span><span class="pi">:</span> <span class="m">10000</span> <span class="c1"># maximum number of samples in each request from device to receiver. Optional</span>
        <span class="na">timeoutSeconds</span><span class="pi">:</span> <span class="m">10</span> <span class="c1"># timeout for requests to receiver. Optional</span>
        <span class="na">url</span><span class="pi">:</span> <span class="s">https://receiver:19291/api/v1/receive</span> <span class="c1"># the receiver's URL. Used to indicate HTTP/HTTPS. Set to empty in order to disable writing to receiver</span>
</code></pre></div></div>

<h3 id="example-receiver">Example receiver</h3>

<p>We prepared an example for deploying a <a href="https://thanos.io">Thanos</a> receiver.
Example includes deployment with and without TLS. The receiver listens on port
<code class="language-plaintext highlighter-rouge">19291</code> for incoming writes. The deployment’s pod includes a container that
executes a Thanos querier. You can use it for querying the received metrics. It
listens on port <code class="language-plaintext highlighter-rouge">9090</code>.</p>

<p>Without TLS:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receive</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.24.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/thanos</span>
        <span class="pi">-</span> <span class="s">receive</span>
        <span class="pi">-</span> <span class="s">--label</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">receiver=</span><span class="se">\"</span><span class="s">0</span><span class="se">\"</span><span class="s">"</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">query</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.24.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/thanos</span>
        <span class="pi">-</span> <span class="s">query</span>
        <span class="pi">-</span> <span class="s">--http-address</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:9090</span>
        <span class="pi">-</span> <span class="s">--grpc-address</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:11901</span>
        <span class="pi">-</span> <span class="s">--endpoint</span>
        <span class="pi">-</span> <span class="s">127.0.0.1:10901</span>
</code></pre></div></div>

<p>With TLS:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">apiVersion</span><span class="pi">:</span> <span class="s">apps/v1</span>
<span class="na">kind</span><span class="pi">:</span> <span class="s">Deployment</span>
<span class="na">metadata</span><span class="pi">:</span>
  <span class="na">name</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
  <span class="na">labels</span><span class="pi">:</span>
    <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
<span class="na">spec</span><span class="pi">:</span>
  <span class="na">replicas</span><span class="pi">:</span> <span class="m">1</span>
  <span class="na">selector</span><span class="pi">:</span>
    <span class="na">matchLabels</span><span class="pi">:</span>
      <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
  <span class="na">template</span><span class="pi">:</span>
    <span class="na">metadata</span><span class="pi">:</span>
      <span class="na">labels</span><span class="pi">:</span>
        <span class="na">app</span><span class="pi">:</span> <span class="s">thanos-receiver</span>
    <span class="na">spec</span><span class="pi">:</span>
      <span class="na">initContainers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">http-config</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">fedora</span>
        <span class="na">command</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">/bin/sh"</span><span class="pi">]</span>
        <span class="na">args</span><span class="pi">:</span> <span class="pi">[</span><span class="s2">"</span><span class="s">-c"</span><span class="pi">,</span> <span class="s2">"</span><span class="s">echo</span><span class="nv"> </span><span class="s">-e</span><span class="nv"> </span><span class="se">\"</span><span class="s">tls_server_config:</span><span class="se">\\</span><span class="s">n</span><span class="nv">  </span><span class="s">cert_file:</span><span class="nv"> </span><span class="s">/etc/server-tls/tls.crt</span><span class="se">\\</span><span class="s">n</span><span class="nv">  </span><span class="s">key_file:</span><span class="nv"> </span><span class="s">/etc/server-tls/tls.key</span><span class="se">\"</span><span class="nv"> </span><span class="s">&gt;</span><span class="nv"> </span><span class="s">/etc/shared/http.config"</span><span class="pi">]</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/shared</span>
      <span class="na">containers</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">receive</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.24.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/thanos</span>
        <span class="pi">-</span> <span class="s">receive</span>
        <span class="pi">-</span> <span class="s">--label</span>
        <span class="pi">-</span> <span class="s2">"</span><span class="s">receiver=</span><span class="se">\"</span><span class="s">0</span><span class="se">\"</span><span class="s">"</span>
        <span class="pi">-</span> <span class="s">--remote-write.server-tls-cert</span>
        <span class="pi">-</span> <span class="s">/etc/server-tls/tls.crt</span>
        <span class="pi">-</span> <span class="s">--remote-write.server-tls-key</span>
        <span class="pi">-</span> <span class="s">/etc/server-tls/tls.key</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">server-tls</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/server-tls</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">query</span>
        <span class="na">image</span><span class="pi">:</span> <span class="s">quay.io/thanos/thanos:v0.24.0</span>
        <span class="na">command</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="s">/bin/thanos</span>
        <span class="pi">-</span> <span class="s">query</span>
        <span class="pi">-</span> <span class="s">--http-address</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:9090</span>
        <span class="pi">-</span> <span class="s">--grpc-address</span>
        <span class="pi">-</span> <span class="s">0.0.0.0:11901</span>
        <span class="pi">-</span> <span class="s">--endpoint</span>
        <span class="pi">-</span> <span class="s">127.0.0.1:10901</span>
        <span class="pi">-</span> <span class="s">--http.config</span>
        <span class="pi">-</span> <span class="s">/etc/shared/http.config</span>
        <span class="na">volumeMounts</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">server-tls</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/server-tls</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
          <span class="na">mountPath</span><span class="pi">:</span> <span class="s">/etc/shared</span>
      <span class="na">volumes</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">server-tls</span>
        <span class="na">secret</span><span class="pi">:</span>
          <span class="na">secretName</span><span class="pi">:</span> <span class="s">thanos-receiver-tls</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">shared</span>
        <span class="na">emptyDir</span><span class="pi">:</span> <span class="pi">{}</span>
</code></pre></div></div>

<h2 id="operator-metrics">Operator Metrics</h2>

<p>In order to publish the metrics to Openshift, the following step yaml need to to
be applied:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>kubectl apply <span class="nt">-f</span> - <span class="o">&lt;&lt;</span><span class="no">EOF</span><span class="sh">
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-monitoring-config
  namespace: openshift-monitoring
data:
  config.yaml: |
</span><span class="no">EOF
</span></code></pre></div></div>

<h2 id="grafana-dashboard">Grafana dashboard</h2>
<p>In order to install Grafana in flotta namespace, the use the following script
which will install the Grafana and Grafana Dashboard.</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>your-kubeconfig-file
tools/deploy_grafana.sh <span class="nt">-d</span> contrib/metrics/flotta-dashboard.json
</code></pre></div></div>

<p>To import any additional Grafana dashboard to existing Grafana in flotta
namespace, use following script:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">export </span><span class="nv">KUBECONFIG</span><span class="o">=</span>your-kubeconfig-file
tools/import_grafana_dashboards.sh <span class="nt">-d</span> &lt;dashboard file&gt;
</code></pre></div></div>

<p>Specifically, it can be used to install edge device health monitoring
dashboard (flotta-operator/docs/metrics/flotta-devices-health.json):</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>tools/import_grafana_dashboards.sh <span class="nt">-d</span> contrib/metrics/flotta-devices-health.json
</code></pre></div></div>

<p>All these scripts are part of flotta-operator github repo.</p>

        </div>
      </div>
    </div>
  </div>
</section>


  <!-- footer -->
<footer class="bg-dark footer-section">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5 class="text-light">Email</h5>
          <p class="text-white paragraph-lg font-secondary">flotta@redhat.com</p>
        </div>
        <div class="col-md-4">
          <h5 class="text-light">Supported by</h5>
          <h5><a href="http://www.redhat.com"><img id="sponsorship" class="footerLogo" src="/assets/images/Logo-Red_Hat-Supported_By-A-Reverse-RGB.svg"></a>.</h5>
        </div>
        <!-- <div class="col-md-4"> -->
        <!--   <h5 class="text-light">Address</h5> -->
        <!--   <p class="text-white paragraph-lg font-secondary"></p> -->
        <!-- </div> -->
      </div>
    </div>
  </div>
  <div class="border-top text-center border-dark py-5">
    <p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p>
</p>
  </div>
</footer>
<!-- /footer -->


<!-- JS Plugins -->

<script src="/assets/plugins/jQuery/jquery.min.js"></script>

<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/assets/plugins/shuffle/shuffle.min.js"></script>

<script src="/assets/plugins/slick/slick.min.js"></script>


<!-- Main Script -->
<script src="/assets/js/script.js"></script>


</body>

</html>
