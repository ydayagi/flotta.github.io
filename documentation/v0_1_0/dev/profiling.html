<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Profiling</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="this is meta description">
    
  
  
  <!-- ** Plugins Needed for the Project ** -->
  
  <link rel="stylesheet" href="/assets/plugins/bootstrap/bootstrap.min.css">
  
  <link rel="stylesheet" href="/assets/plugins/themify-icons/themify-icons.css">
  
  <link rel="stylesheet" href="/assets/plugins/slick/slick.css">
  

  <link href="/assets/scss/syntax_monokai.css" rel="stylesheet">
  <!-- Main Stylesheet -->
  <link href="/assets/scss/style.css" rel="stylesheet">

  <!--Favicon-->
  <link rel="shortcut icon" href="/assets/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="/assets/images/flotta-logo-stacked.ico " type="image/x-icon">

  <!-- google analytics -->
  

</head>


<body>

  <header class="navigation fixed-top nav-bg">
  <nav class="navbar navbar-expand-lg navbar-dark">
    <a class="navbar-brand font-tertiary h3" href="/">
      
        <img src="/assets/images/flotta-logo.png" alt="Project Flotta" style="height: 60px;">
        
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navigation"
      aria-controls="navigation" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse text-center" id="navigation">
      <ul class="navbar-nav ml-auto">
        <li class="nav-item active">
          <a class="nav-link" href="/">Home</a>
        </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/blog.html">Blog</a>
          </li>
        
          <li class="nav-item ">
            <a class="nav-link" href="/documentation/v0_1_0/intro/overview.html">Documentation</a>
          </li>
        
      </ul>
    </div>
  </nav>
</header>


  <section class="section skip_top">
  <div class="container">
    <div class="row">
      <div class="col-lg-4">
        
        
        <ul class="list-group list-group-collapse border-0">
          
            <li class="list-group-item border-0">
              <h5>
                
                  Intro
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/overview.html">What is flotta</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/usecases.html">Use cases</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/vs.html">Flotta vs others</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/intro/concepts.html">Concepts</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  Getting started
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/minikube.html">Minikube</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/kind.html">Kind</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/ocp.html">OCP</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/gsg/running_workloads.html">Running workloads</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  Operations
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/requirements.html">System Requirements</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/deployment_options.html">Deployment options</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/configuration.html">Configuration</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/observability.html">Observability</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/data_upload.html">Data upload</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/troubleshooting.html">Troubleshooting</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/api.html">API reference</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/operations/crd.html">CRD reference</a> </li>
                  
                </ul>
              
            </li>
          
            <li class="list-group-item border-0">
              <h5>
                
                  For developers
                
              </h5>
              
                <ul class="list-group border-0">
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/installation.html">Manual installation & tips</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/guide.html">Development Guide</a> </li>
                  
                    
                    <li class="list-group-item border-0"> <a href="/documentation/v0_1_0/dev/profiling.html">Profiling</a> </li>
                  
                </ul>
              
            </li>
          
        </ul>
        <p>Documentation for version: <b>v0.1.0</b></p>
        <b>Other versions</b>
        <ul class="list-group list-group-collapse border-0">
        
          
          
            <li class="list-group-item border-0">

              
              <a href="/documentation/latest/intro/overview.html"> latest</a>
            </li>
        
          
          
            <li class="list-group-item border-0">

              
              <a href="/documentation/v0_1_0/intro/overview.html"> v0.1.0</a>
            </li>
        
        </ul>
      </div>

      <div class="col-lg-8">
        <div class="documentation content">
          
            <!-- Some cases we don't want to show the title -->
            <h1 class="font-tertiary mb-5">Profiling</h1>
          
          

          <h1 id="profiling-flotta-operator">Profiling Flotta Operator</h1>

<p>In order to enable profiling for all Flotta Operator components by pprof, few steps are required:</p>

<p>Add the following to the start of the <strong>main.go</strong> file:</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">mux</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">NewServeMux</span><span class="p">()</span>
<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/debug/pprof/"</span><span class="p">,</span> <span class="n">pprof</span><span class="o">.</span><span class="n">Index</span><span class="p">)</span>
<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/debug/pprof/cmdline"</span><span class="p">,</span> <span class="n">pprof</span><span class="o">.</span><span class="n">Cmdline</span><span class="p">)</span>
<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/debug/pprof/profile"</span><span class="p">,</span> <span class="n">pprof</span><span class="o">.</span><span class="n">Profile</span><span class="p">)</span>
<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/debug/pprof/symbol"</span><span class="p">,</span> <span class="n">pprof</span><span class="o">.</span><span class="n">Symbol</span><span class="p">)</span>
<span class="n">mux</span><span class="o">.</span><span class="n">HandleFunc</span><span class="p">(</span><span class="s">"/debug/pprof/trace"</span><span class="p">,</span> <span class="n">pprof</span><span class="o">.</span><span class="n">Trace</span><span class="p">)</span>

<span class="k">go</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span>
    <span class="n">http</span><span class="o">.</span><span class="n">ListenAndServe</span><span class="p">(</span><span class="s">":6060"</span><span class="p">,</span> <span class="n">mux</span><span class="p">)</span>
<span class="p">}()</span>
</code></pre></div></div>
<p>Add required import as well to the <strong>main.go</strong> file:</p>
<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="n">_</span> <span class="s">"net/http/pprof"</span>
</code></pre></div></div>

<p>The profiling data is exposed on port 6060 of the Flotta Operator pod, once built and deployed.</p>

<p>To view the profiling data, and visualize it nicely, use <a href="https://pyroscope.io/"><code class="language-plaintext highlighter-rouge">pyroscope</code></a>.</p>

<p>To install <code class="language-plaintext highlighter-rouge">pyroscope</code>:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>-&gt; helm repo add pyroscope-io https://pyroscope-io.github.io/helm-chart
<span class="nv">$ </span>-&gt; helm <span class="nb">install </span>pyroscope pyroscope-io/pyroscope <span class="nt">-f</span> https://raw.githubusercontent.com/pyroscope-io/pyroscope/main/examples/golang-pull/kubernetes/values.yaml
<span class="nv">$ </span>-&gt; kubectl expose svc pyroscope

<span class="c"># for openshift, get the address for pyroscope service:</span>
<span class="nv">$ </span>-&gt; kubectl get route pyroscope kubectl get routes pyroscope <span class="nt">--no-headers</span> <span class="nt">-o</span><span class="o">=</span>custom-columns<span class="o">=</span>HOST:.spec.host 
</code></pre></div></div>

<p>There is need to patch flotta’s resources to expose targets and mark pods for profiling:</p>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>-&gt; kubectl patch deployment flotta-operator-controller-manager <span class="nt">-n</span> flotta <span class="nt">-p</span> <span class="s1">'
  { "spec": {
      "template": {
        "spec":
          { "containers":
            [{"name": "manager",
              "ports": [
                  {
                      "containerPort": 6060,
                      "name": "pprof",
                      "protocol": "TCP"
                  }
              ]
            }]
          }
        }
      }
  }'</span>

<span class="nv">$ </span>-&gt; kubectl patch service flotta-operator-controller-manager <span class="nt">-n</span> flotta <span class="nt">-p</span> <span class="s1">'
  { "spec": {
      "ports": [
          {
              "name": "pprof",
              "port": 6060,
              "protocol": "TCP",
              "targetPort": "pprof"
          }
      ]
  }
  }'</span>

<span class="nv">$ </span>-&gt; kubectl patch deployment <span class="nt">-n</span> flotta flotta-operator-controller-manager <span class="nt">-p</span> <span class="s1">'
   {
     "spec": {
       "template":{
         "metadata":{
           "annotations":{
             "pyroscope.io/scrape": "true",
             "pyroscope.io/application-name": "flotta-operator",
             "pyroscope.io/profile-cpu-enabled": "true",
             "pyroscope.io/profile-mem-enabled": "true",
             "pyroscope.io/port": "6060"
           }
         }
       }
     }
  }'</span>
</code></pre></div></div>

<p>Restart the Flotta Operator to apply the changes.</p>

        </div>
      </div>
    </div>
  </div>
</section>


  <!-- footer -->
<footer class="bg-dark footer-section">
  <div class="section">
    <div class="container">
      <div class="row">
        <div class="col-md-4">
          <h5 class="text-light">Email</h5>
          <p class="text-white paragraph-lg font-secondary">flotta@redhat.com</p>
        </div>
        <div class="col-md-4">
          <h5 class="text-light">Supported by</h5>
          <h5><a href="http://www.redhat.com"><img id="sponsorship" class="footerLogo" src="/assets/images/Logo-Red_Hat-Supported_By-A-Reverse-RGB.svg"></a>.</h5>
        </div>
        <!-- <div class="col-md-4"> -->
        <!--   <h5 class="text-light">Address</h5> -->
        <!--   <p class="text-white paragraph-lg font-secondary"></p> -->
        <!-- </div> -->
      </div>
    </div>
  </div>
  <div class="border-top text-center border-dark py-5">
    <p class="mb-0 text-light"><p>Copyright © 2020 Designed by <a href="https://themefisher.com">Themefisher</a> &amp; Developed by <a href="https://getjekyllthemes.com">Getjekyllthemes</a></p>
</p>
  </div>
</footer>
<!-- /footer -->


<!-- JS Plugins -->

<script src="/assets/plugins/jQuery/jquery.min.js"></script>

<script src="/assets/plugins/bootstrap/bootstrap.min.js"></script>

<script src="/assets/plugins/shuffle/shuffle.min.js"></script>

<script src="/assets/plugins/slick/slick.min.js"></script>


<!-- Main Script -->
<script src="/assets/js/script.js"></script>


</body>

</html>
